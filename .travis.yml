# It's slightly tempting to automate testing of TCC reload working, sandbox not
# faulting, doing a matrix across the two features...
# 
# The starting point, though, is validating that the autotools pain was at all
# worth it. Does the base library build? Good.
#
# The optional features might flow down from Arch/Gentoo's nice build
# environments in the future.
language: c
compiler: gcc

matrix:
  allow_failures:
    - os: osx
    - dist: precise
  include:
    - os: linux
      env: NOTE="Ubuntu trusty, close enough to Arch to build reliably"
      dist: trusty
      sudo: false # going to try the fancy Beta stuff
      addons:
        apt:
          packages: # tcc/seccomp don't seem to be in the whitelist, oh well!
            - libncursesw5-dev
      script:
        - echo "travis_fold:start:bootstrap_and_configure"
        - ./bootstrap 
        - ./configure 
        - echo "travis_fold:end:bootstrap_and_configure"
        - make
        - "LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/lib"
        - "PATH=$PATH:$(pwd)/bin"
        - "make DESTDIR=$(pwd) install"
        - echo "travis_fold:start:smoke_test_cannot_look"
        - time timeout 1 blindsight `which blindsight` || true
        - echo "travis_fold:end:smoke_test_cannot_look"
    - os: linux
      env: NOTE="Ubuntu precise, old automake incapable of clean builds"
      dist: precise 
      sudo: required
      before_install:
        - sudo apt-get update -qq # automake... I'm dependant on at least 1.13? Yuck.
        - automake --version      # AC_CONFIG_MACRO_DIRS is showstopper, probably others too.
        - sudo apt-get install -qq libncursesw5-dev libseccomp-dev libtcc-dev tcc
      script:
        - echo "travis_fold:start:bootstrap_and_configure"
        - ./bootstrap && ./configure
        - echo "travis_fold:end:bootstrap_and_configure"
        - make
        - sudo make install
        - echo "travis_fold:start:smoke_test_cannot_look"
        - time timeout 1 blindsight `which blindsight` || true
        - echo "travis_fold:end:smoke_test_cannot_look"
    - os: osx # amazingly this works
      env: NOTE="Only OSX build I'll ever test"
      before_install:
        - brew update
        - brew install ncurses  # built with --enable-widec
                                # symlinked ncursesw/ncurses.h 
                                # libncurses.dylib
      script:
        - ./bootstrap 
        - ./configure 
        - make
        - make install
        - echo "travis_fold:start:smoke_test_cannot_look"
        - time gtimeout 1 blindsight `which blindsight` || true
        - echo "travis_fold:end:smoke_test_cannot_look"
    - os: linux
      env: NOTE="Arch chroot test"
      dist: precise
      sudo: required
      before_install:
        - "curl -s https://raw.githubusercontent.com/mikkeloscar/arch-travis/master/arch-travis.sh | bash"
      script: 
        - echo "travis_fold:end:makepkg"

# parsed by arch-travis.sh, not travis-ci:
arch:
  packages:
    - autoconf  # build-time
    - tcc
    - ncurses
    - libseccomp  # optional
  script:
    - echo "travis_fold:start:makepkg"
    - "(cd pkg/pacman && makepkg -i)"
    - echo "travis_fold:start:smoke_test_cannot_look"
    - time timeout 1 blindsight `which blindsight` || true  # TODO check $? 124
    - echo "travis_fold:end:smoke_test_cannot_look"

